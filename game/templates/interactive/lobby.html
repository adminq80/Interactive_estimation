{% extends 'base.html' %}
{% load staticfiles %}

{% block container %}
    <div class="row">
        <div class="col-md-12" id="waiting">Waiting for other players ...</div>
    </div>
    <p>Please wait a few moments while we try to find the needed participants.</p>
    <p>If we can't find enough participants within {{lobbyTimeout}} minutes, we will end the HIT and pay you for your time.</p>
    <p>Please make sure your sound is on as a bell will ring to indicate the start of a new game.</p>
{% endblock %}


{% block extra_javascript %}

    <script src="{% static "js/jquery-1.12.2.min.js" %}"></script>
    <script src="{% static "js/reconnecting-websocket.min.js" %}" type="text/javascript"></script>

    <script>
        $(function () {
            var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
            var ws_path = ws_scheme + '://' + window.location.host + "/multiplayer/lobby/";

            console.log("Connecting to " + ws_path);
            socket = new ReconnectingWebSocket(ws_path);

            // Helpful debugging
            socket.onopen = function () {
                console.log("Connected to chat socket");
            };

            socket.onclose = function () {
                console.log("Disconnected from chat socket");
            };

            socket.onmessage = function (msg) {

                var data = JSON.parse(msg.data);

                console.log("JUST got a message " + msg);

                if(data.action == "info"){
                    document.querySelector('#waiting').innerHTML = data.text;
                }
                else if(data.action == "redirect"){
                    var proto = ws_scheme == "wss" ? "https://" : "http://";
                    window.location.href = proto + window.location.host + data.url;
                }
                else{
                    console.log(data)
                }
            };

        });
    </script>
{% endblock %}